function handleVoiceCommand(command) {
    announceToScreenReader('Command received: ' + command);
    updateVoiceStatus(`"${command}"`);
    console.log('Processing voice command:', command);

    // Clean and normalize the command - handle voice recognition issues with room numbers
    const cleanCommand = normalizeVoiceInput(command);
    
    // Emergency stop - highest priority
    if (cleanCommand.includes('emergency') || cleanCommand.includes('stop navigation') || cleanCommand.includes('cancel')) {
        if (scanning) stopCamera();
        if (currentMode !== NavigationMode.IDLE) {
            stopNavigation();
        }
        stopListening(); // Stop listening after emergency command
        queueSpeech('Navigation stopped', 'urgent', true);
        return;
    }

    // Handle mode-specific commands first
    if (currentMode === NavigationMode.DESTINATION_INPUT) {
        if (cleanCommand.includes('go to') || cleanCommand.includes('navigate to') || cleanCommand.includes('take me to')) {
            const destinationId = parseDestination(cleanCommand);
            if (destinationId) {
                const destName = roomInfo[destinationId] || destinationId;
                queueSpeech(`Going to ${destName}`, 'normal');
                stopListening(); // Stop listening after successful destination
                startNavigation(destinationId);
                return;
            } else {
                queueSpeech('Room not found. Try saying: go to cisco lab, or go to lecture room 1.', 'normal');
                return;
            }
        }
        
        // If in destination input mode but command doesn't match, provide help
        if (!cleanCommand.includes('help') && !cleanCommand.includes('cancel')) {
            queueSpeech('Say: go to, followed by room name. Say help for room list.', 'normal');
            return;
        }
    }

    // Navigation-specific commands
    if (currentMode === NavigationMode.NAVIGATING) {
        if (cleanCommand.includes('scan qr') || cleanCommand.includes('checkpoint') || cleanCommand.includes('check point')) {
            queueSpeech('Looking for checkpoint QR code. Point camera at QR code.', 'normal');
            return;
        }

        if (cleanCommand.includes('route') || cleanCommand.includes('where am i going')) {
            if (currentRoute && destination) {
                const destName = roomInfo[destination] || destination;
                const remaining = currentRoute.slice(routeStep);
                const nextStop = remaining.length > 1 ? roomInfo[remaining[1]] || remaining[1] : destName;
                queueSpeech(`Going to ${destName}. Next: ${nextStop}`, 'normal');
            } else {
                queueSpeech('No active route', 'normal');
            }
            return;
        }

        if (cleanCommand.includes('progress') || cleanCommand.includes('how far')) {
            if (currentRoute) {
                const totalSteps = currentRoute.length;
                const remainingSteps = totalSteps - routeStep;
                queueSpeech(`${remainingSteps} of ${totalSteps} waypoints remaining.`, 'normal');
            } else {
                queueSpeech('No active route', 'normal');
            }
            return;
        }
        
        if (cleanCommand.includes('stop') || cleanCommand.includes('end navigation')) {
            stopNavigation();
            queueSpeech('Navigation stopped', 'normal');
            return;
        }
    }

    // General commands available in any mode
    if (cleanCommand.includes('scan') && cleanCommand.includes('qr')) {
        startQRScanning();
        return;
    } 
    
    if (cleanCommand.includes('start camera') || cleanCommand.includes('start navigation')) {
        if (!currentLocation) {
            queueSpeech('Scan QR code first to set your location', 'normal');
        } else {
            toggleCamera();
        }
        return;
    } 
    
    if (cleanCommand.includes('where am i') || cleanCommand.includes('current location')) {
        if (currentLocation) {
            const locationName = roomInfo[currentLocation] || currentLocation;
            queueSpeech(`You are at ${locationName}`, 'normal');
        } else {
            queueSpeech('Location unknown. Scan a QR code first.', 'normal');
        }
        return;
    }
    
    if (cleanCommand.includes('what') || cleanCommand.includes('describe') || cleanCommand.includes('repeat')) {
        if (lastResult) {
            queueSpeech(lastResult, 'normal');
        } else {
            queueSpeech('No instructions available yet', 'info');
        }
        return;
    }
    
    if (cleanCommand.includes('help')) {
        speakHelp();
        return;
    }
    
    if (cleanCommand.includes('room list') || cleanCommand.includes('available rooms')) {
        speakAvailableRooms();
        return;
    }

    // If no command matched, provide contextual help
    if (currentMode === NavigationMode.IDLE) {
        queueSpeech('Say: scan QR code, or help for commands', 'normal');
    } else if (currentMode === NavigationMode.DESTINATION_INPUT) {
        queueSpeech('Say: go to, followed by room name', 'normal');
    } else {
        queueSpeech('Command not recognized. Say help for options.', 'normal');
    }
}
